#!/bin/sh

# Install nginx if it's not installed
command -v nginx >/dev/null 2>&1 || {
    echo "Installing nginx..."
    apk update && apk add nginx
}

# Create web root with a test index.html
mkdir -p /var/www/html
echo "<h1>Welcome to nginx on port 8080</h1>" > /var/www/html/index.html

# Kill any process using port 80 to avoid conflicts
echo "Checking and freeing up port 80..."
PORT_80_PID=$(netstat -tulpn 2>/dev/null | grep ":80 " | awk '{print $7}' | cut -d/ -f1)
[ -n "$PORT_80_PID" ] && kill -9 $PORT_80_PID

# Ensure nginx runs as the 'nginx' user
sed -i 's/^user .*/user nginx;/' /etc/nginx/nginx.conf

# Overwrite default server block to listen on 8080
cat <<EOF > /etc/nginx/http.d/default.conf
server {
    listen 8080 default_server;
    listen [::]:8080 default_server;

    root /var/www/html;
    index index.html;

    location / {
        try_files \$uri \$uri/ =404;
    }
}
EOF

# Kill any existing nginx process
pkill nginx || true

# Start nginx
echo "Starting nginx on port 8080..."
nginx

# Check status
sleep 1
echo "Testing connection to port 8080..."
curl -I 127.0.0.1:8080

