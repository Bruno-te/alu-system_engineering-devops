#!/usr/bin/env bash
# This script installs nginx and configures it to run as nginx user on port 8080

# Install nginx if not installed
if ! command -v nginx >/dev/null 2>&1; then
    apk update
    apk add nginx
fi

# Create web root directory and a test index.html
mkdir -p /var/www/html
echo "<h1>Welcome to nginx on port 8080</h1>" > /var/www/html/index.html

# Stop any process using port 8080
pid=$(netstat -tulpn 2>/dev/null | grep ':8080 ' | awk '{print $7}' | cut -d'/' -f1)
if [ -n "$pid" ]; then
    kill -9 "$pid"
fi

# Make sure nginx runs as 'nginx' user
sed -i 's/^user .*/user nginx;/' /etc/nginx/nginx.conf

# Configure nginx to listen on port 8080 and serve the web root
cat > /etc/nginx/http.d/default.conf << EOF
server {
    listen 8080 default_server;
    listen [::]:8080 default_server;

    root /var/www/html;
    index index.html;

    location / {
        try_files \$uri \$uri/ =404;
    }
}
EOF

# Stop any running nginx
pkill nginx 2>/dev/null || true

# Start nginx
nginx

# Wait a moment then test nginx is listening and responding
sleep 1
curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8080
